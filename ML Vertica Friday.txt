-- Vertica SQL Machine Learning

DROP TABLE IF EXISTS sopra.trainsample;
DROP TABLE IF EXISTS sopra.testsample;

CREATE TABLE sopra.trainsample AS SELECT * FROM sopra.preprocessing_post_OHE2 TABLESAMPLE(75);
CREATE TABLE sopra.testsample AS SELECT * FROM sopra.preprocessing_post_OHE2 TABLESAMPLE(25);

DROP MODEL IF EXISTS sopra.Balanced_trainsample;
DROP VIEW IF EXISTS sopra.Balanced_trainsample;

SELECT BALANCE('sopra.Balanced_trainsample', 'sopra.trainsample','sensor_id','weighted_sampling');

DROP MODEL IF EXISTS RF_reg;

DROP TABLE IF EXISTS sopra.Train;

CREATE TABLE sopra.Train AS SELECT sensor_id,Ozone,temp24,temp48,temp168,DayOfMonth,Weekday,Hour,Month
FROM sopra.Balanced_trainsample;

SELECT * FROM sopra.Train;

SELECT RF_REGRESSOR('RF_reg', 'sopra.Train', 'ozone', 'sensor_id,temp24,temp48,temp168,DayOfMonth,Weekday,Hour,Month'
      USING PARAMETERS 
                   min_info_gain = 0.001,
                   ntree=20,
                   max_depth= 100,
                   max_breadth=1000);

SELECT GET_MODEL_SUMMARY (USING PARAMETERS model_name='RF_reg');
